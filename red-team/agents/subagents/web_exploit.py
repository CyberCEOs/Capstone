import dspy
from .base import BaseRedAgent
import os
import sys
# Ensure the `red-team` directory is on sys.path so `tools.interface` can be imported
RED_TEAM_ROOT = os.path.dirname(os.path.dirname(os.path.dirname(__file__)))
if RED_TEAM_ROOT not in sys.path:
    sys.path.insert(0, RED_TEAM_ROOT)
# Ryan needs to implement 'run_nikto' or 'sqlmap_attack' in interface.py
from tools.interface import sqlmap_attack 

class WebExploitSignature(dspy.Signature):
    """
    You are the Web Exploitation Specialist.
    Analyze HTTP services to find app-level flaws (SQLi, XSS).
    """
    open_ports = dspy.InputField(desc="List of open ports (e.g., 80, 3000, 8080)")
    attack_vector = dspy.OutputField(desc="Specific web attack to launch (e.g., 'SQLMap', 'Nikto', 'DirectoryBuster')")

class WebExploitAgent(BaseRedAgent):
    def __init__(self):
        super().__init__("WEB_EXPLOIT", "Breach web applications.")
        self.decider = dspy.ChainOfThought(WebExploitSignature)

    def execute(self, scan_data):
        self.log("Analyzing web surface...")
        plan = self.decider(open_ports=str(scan_data))
        
        if "sql" in plan.attack_vector.lower():
            self.log("Launching SQL Injection attack...")
            # Ryan needs to map this tool
            return sqlmap_attack("http://target:3000/rest/products/search?q=")
            
        return {"success": False, "note": "No valid web vector found"}